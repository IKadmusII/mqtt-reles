<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Relés</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>

  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    .btn { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
    .on { background-color: green; color: white; }
    .off { background-color: red; color: white; }
    #status { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Controle dos Relés via MQTT</h1>

  <div>
    <h2>Relé 1</h2>
    <button class="btn on" onclick="sendCmd('casa/rele1', 'ON')">Ligar</button>
    <button class="btn off" onclick="sendCmd('casa/rele1', 'OFF')">Desligar</button>
    <div id="stat1">Status: --</div>
  </div>
  <div>
    <h2>Relé 2</h2>
    <button class="btn on" onclick="sendCmd('casa/rele2', 'ON')">Ligar</button>
    <button class="btn off" onclick="sendCmd('casa/rele2', 'OFF')">Desligar</button>
    <div id="stat2">Status: --</div>
  </div>
  <div>
    <h2>Relé 3</h2>
    <button class="btn on" onclick="sendCmd('casa/rele3', 'ON')">Ligar</button>
    <button class="btn off" onclick="sendCmd('casa/rele3', 'OFF')">Desligar</button>
    <div id="stat3">Status: --</div>
  </div>
  <div>
    <h2>Relé 4</h2>
    <button class="btn on" onclick="sendCmd('casa/rele4', 'ON')">Ligar</button>
    <button class="btn off" onclick="sendCmd('casa/rele4', 'OFF')">Desligar</button>
    <div id="stat4">Status: --</div>
  </div>

  <div id="status">MQTT: Conectando...</div>

  <script>
    
    const host = "mqtt.flespi.io";
    const port = 443;
    const path = "/mqtt";
    const token = "jbaSYJl5Mb83cxwtoTnHiHBtye3vuvX7K0BUuqNyQhFJuvawUDB4zjvxNKEAVWTl";

    
    const client = new Paho.MQTT.Client(host, port, path, "webclient_" + Math.random().toString(16).substr(2, 8));

    client.onConnectionLost = function(responseObject) {
      document.getElementById("status").innerText = "MQTT: conexão perdida";
    };

    client.onMessageArrived = function(message) {
      const topic = message.destinationName;
      const payload = message.payloadString;
      console.log(`Recebido: ${topic} => ${payload}`);

      // Atualiza os status dos relés
      if (topic === "casa/rele1/status") document.getElementById("stat1").innerText = "Status: " + payload;
      if (topic === "casa/rele2/status") document.getElementById("stat2").innerText = "Status: " + payload;
      if (topic === "casa/rele3/status") document.getElementById("stat3").innerText = "Status: " + payload;
      if (topic === "casa/rele4/status") document.getElementById("stat4").innerText = "Status: " + payload;
    };

    
    client.connect({
      useSSL: true,
      userName: token,
      onSuccess: function() {
        document.getElementById("status").innerText = "MQTT: conectado!";
        console.log("Conectado ao MQTT!");

        
        client.subscribe("casa/rele1/status");
        client.subscribe("casa/rele2/status");
        client.subscribe("casa/rele3/status");
        client.subscribe("casa/rele4/status");
      },
      onFailure: function(err) {
        document.getElementById("status").innerText = "MQTT: falha ao conectar";
        console.error("Erro ao conectar MQTT:", err);
      }
    });

    
    function sendCmd(topic, message) {
      if (!client.isConnected()) {
        alert("MQTT desconectado!");
        return;
      }
      const msg = new Paho.MQTT.Message(message);
      msg.destinationName = topic;
      client.send(msg);
    }
  </script>
</body>
</html>
